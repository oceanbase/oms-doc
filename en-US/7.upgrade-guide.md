# Upgrade Guide

This topic describes the procedure for upgrading to OceanBase Migration Service (OMS) Community Edition 3.3.0-CE. 

## Upgrade procedure

1. Back up the databases. 
   
   1. Suspend operations on the container of OMS Community Edition V3.2.2-CE. 

      ```
      sudo docker stop ${CONTAINER_NAME}
      ```

      >Notice：
      >
      >`CONTAINER_NAME` represents the name of the container in the oms_xxx format. Specify xxx based on the actual OMS version. 

   2. Log on to the cluster management (CM) heartbeat database specified in the configuration file and delete some useless records to save backup time. 

      ```
      # Log on to the CM heartbeat database specified in the configuration file.
      mysql -h10.10.10.1 -P<port> -u<username> -p<password> -Dcm_hb_322

      # Obtain the auto-increment ID from heatbeat_sequence, which reports the heartbeat.
      select max(id) from heatbeat_sequence;

      # Delete useless records.
      delete from heatbeat_sequence where id < the maximum ID returned by the preceding SQL statement;
      ```
   
   3. Run the following command to back up the rm, cm, and cm_hb databases as SQL files and make sure that the sizes of the three files are not 0. 

      ```
      mysqldump -h10.10.10.1 -P<port> -u<username> -p<password> --triggers=false rm_322 > /home/admin/rm_322.sql

      mysqldump -h10.10.10.1 -P<port> -u<username> -p<password> --triggers=false cm_322 > /home/admin/cm_322.sql

      mysqldump -h10.10.10.1 -P<port> -u<username> -p<password> --triggers=false cm_hb_322 > /home/admin/cm_hb_322bp.sql
      ```

      |Parameter|Description|
      |---|---|
      |-h|The IP address of the host from which the data is exported. |
      |-P|The port number used to connect to the database. |
      |-u|The username used to connect to the database. |
      |-p|The password used to connect to the database. |
      |--triggers|The data export trigger. The default value is false, which disables data export. |
      |rm_322<br>cm_322<br>cm_hb 322|The backup SQL files of rm, cm, and cm_hb databases with names in the `database name > SQL file storage path.sql` format. You need to replace the values based on the actual environment. |
   
2. Start the new container of OMS Community Edition V3.3.0-CE. 

   You can access the OMS Community Edition console using a HTTP or HTTPS URL. To securely access the OMS Community Edition console, install an SSL certificate and mount it to the specified directory in the container. The certificate is not required for HTTP access. 

   >Notice：
   >
   >Before you start the container of OMS Community Edition V3.3.0-CE, make sure that the three disk mounting paths of OMS are the same as those before the upgrade. 
   >You can run the `sudo docker inspect ${CONTAINER_NAME}  grep -A5 'Binds'` command to view the paths. 

    ```shell
   OMS_HOST_IP=xxx
   CONTAINER_NAME=oms_xxx
   IMAGE_TAG=feature_x.x.x_ce

   docker run -dit --net host \
   -v /data/config.yaml:/home/admin/conf/config.yaml \
   -v /data/oms/oms_logs:/home/admin/logs \
   -v /data/oms/oms_store:/home/ds/store \
   -v /data/oms/oms_run:/home/ds/run \
   # If you mount the SSL certificate in the OMS container, you need to set the following two parameters:
   -v /data/oms/https_crt:/etc/pki/nginx/oms_server.crt 
   -v /data/oms/https_key:/etc/pki/nginx/oms_server.key
   -e OMS_HOST_IP=${OMS_HOST_IP} \
   --privileged=true \
   --pids-limit -1 \
   --ulimit nproc=65535:65535 \
   --name ${CONTAINER_NAME} \
   reg.docker.alibaba-inc.com/oceanbase/oms:${IMAGE_TAG}
   ```

   |         Parameter   |  Description
   |---------------------|----------|
   | OMS_HOST_IP         | The IP address of the host. |
   | CONTAINER_NAME      | The name of the container in the oms_xxx format.|
   | IMAGE_TAG           | The tag of the image. To view the image tag, execute the docker images statement after you load the image on the host. |
   | /data/oms/oms_logs<br>/data/oms/oms_store <br> /data/oms/oms_run  | You can replace `/data/oms/oms_logs`, `/data/oms/oms_store`, and `/data/oms/oms_run` with the mount directories created on the server where OMS is deployed. The mount directories store the logs generated during the operating of OMS and generated by stores and synchronization components, respectively, to persistently retain the logs on the server.  <br>**Notice**：The mount directories must remain unchanged during subsequent redeployment or upgrades. | 
   | /home/admin/logs<br>/home/ds/store<br>/home/ds/run    | `/home/admin/logs`, `/home/ds/store`, and `/home/ds/run` are default directories in the container and cannot be modified. |
   |/data/oms/https_crt（optional）<br>/data/oms/https_key（optional）|The mount directory of the SSL certificate in the OMS container. Specify the directory based on your actual configurations. <br>If you mount an SSL certificate, the NGINX service in the OMS container runs in HTTPS mode. In this case, you can access the OMS console using only the HTTPS URL. |
   | privileged          | Specifies whether to grant the container scaling privilege. 
   | pids-limit          | Specifies whether to limit the number of container processes. The value -1 indicates that the number is unlimited.  |
   | ulimit nproc        | The maximum number of user processes. |

3. Perform metadata initialization in the root directory. 

   ```
   bash /root/docker_init.sh
   ```

   After you run the preceding command, the script automatically implements schema changes of the three OMS Community Edition databases. 

4. Optional. To roll back, perform the following steps: 

   1. Suspend operations on the new container.

      ```
      sudo docker stop ${CONTAINER_NAME}
      ```

   2. Restore the SQL files created in Step 1 to the original databases. 

      ```
      drop database rm_322;
      drop database cm_322;
      drop database cm_hb_322;

      create database rm_322;
      create database cm_322;
      create database cm_hb_322;

      mysql -h10.10.10.1 -P<port> -u<username> -p<password> -e "source /home/admin/rm_322.sql" -Drm_322

      mysql -h10.10.10.1 -P<port> -u<username> -p<password> -e "source /home/admin/cm_322.sql" -Dcm_322

      mysql -h10.10.10.1 -P<port> -u<username> -p<password> -e "source /home/admin/cm_hb_322.sql" -Dcm_hb_322
      ```

   3. Restart the container of OMS Community Edition V3.2.2-CE.

      ```
      sudo docker restart ${CONTAINER_NAME}
      ```

