# Deploy OMS Community Edition on a single node

This topic describes how to deploy OceanBase Migration Service (OMS) Community Edition on a single node.

## Prerequisites

* The installation environment meets the system requirements. For more information, see [System requirements](../2.deployment-guide/2.system-requirements.md).

* The MetaOB cluster is prepared as the OMS Community Edition MetaDB.

* The OMS Community Edition installation package is obtained. Generally, the package is a `tar.gz` file whose name starts with oms Community Edition.

## Procedure

1. Log on to the server where OMS Community Edition is to be deployed.

2. Optional. Deploy a time-series database.

   If you need to collect and display OMS Community Edition monitoring data, deploy a time-series database. Otherwise, you can skip this step. For more information, see [Deploy a time-series database](../2.deployment-guide/5.deploy-a-time-series-database.md).

3. Prepare the configuration file.

   Edit the OMS Community Edition configuration file in the appropriate directory. For example, you can create the config.yaml configuration file in the `/root/` directory.

   You must replace the sample values of required parameters based on your actual deployment environment. Optional parameters are also described in this topic. You can modify the optional parameters as needed.

   >**Notice:**
   >
   >In the `config.yaml` file, you must specify the value in the parameter: value format. A space is required after the colon (:).
  
   * The following example describes a template of the `config.yaml` file:

     ```yaml
     # The information about OMS MetaDB.
     oms_meta_host: ${oms_meta_host}
     oms_meta_port: ${oms_meta_port}
     oms_meta_user: ${oms_meta_user}
     oms_meta_password: ${oms_meta_password}
     
     # You can customize the names of the following three databases, which are created in the MetaDB when you deploy OMS.
     drc_rm_db: ${drc_rm_db}
     drc_cm_db: ${drc_cm_db}
     drc_cm_heartbeat_db: ${drc_cm_heartbeat_db}
     
     # The user that consumes the incremental data of OceanBase Database.
     # To read the incremental logs of OceanBase Database, create the user in the SYS tenant.
     # You must create the drc user in the SYS tenant of the OceanBase cluster to be migrated and specify the drc user in the config.yaml file.
     drc_user: ${drc_user}
     drc_password: '${drc_password}'
     
     # Configure the OMS cluster.
     # In single-node deployment mode, the IP address of the server where OMS is deployed is used. We recommend that you use an internal IP address.
     cm_url: ${cm_url}
     cm_location: ${cm_location}
     # The cm_region parameter is not required for single-node deployment.
     # cm_region: ${cm_region}
     # The cm_region_cn parameter is not required for single-node deployment.
     # cm_region_cn: ${cm_region_cn}
     cm_is_default: true
     cm_nodes:
      - ${cm_nodes}
     
     # Configurations of the time-series database.
     # Default value: false. To enable metric reporting, set the parameter to true.
     # tsdb_enabled: false 
     # If the tsdb_enabled parameter is set to true, delete comments for the following parameters and specify the values based on your actual configurations.
     # tsdb_service: 'INFLUXDB'
     # tsdb_url: '${tsdb_url}'
     # tsdb_username: ${tsdb_user}
     # tsdb_password: ${tsdb_password}
     ```

     |      Parameter      |                                                                                                                                                    Description                                                                                                                                                    |           Required           |
     |---------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------|
     | oms_meta_host       | The IP address of MetaDB, which can be the IP address of a MySQL database or a MySQL tenant of OceanBase Database.  <br>**Notice:** <br> OceanBase Database V2.0 or later is required.                                                                                                     | Yes                          |
     | oms_meta_port       | The port number of MetaDB.                                                                                                                                                                                                                                                                                        | Yes                          |
     | oms_meta_user       | The username of MetaDB.                                                                                                                                                                                                                                                                                           | Yes                          |
     | oms_meta_password   | The password of the MetaDB username.                                                                                                                                                                                                                                                                              | Yes                          |
     | drc_rm_db           | The name of the database for the OMS console.                                                                                                                                                                                                                                                                     | Yes                          |
     | drc_cm_db           | The name of the MetaDB for the CM service.                                                                                                                                                                                                                                                                        | Yes                          |
     | drc_cm_heartbeat_db | The name of the heartbeat database for the CM service.                                                                                                                                                                                                                                                            | Yes                          |
     | drc_user            | The user that reads the incremental logs of OceanBase Database. You need to create the user in the SYS tenant. For more information, see the "User privileges" topic in OMS Community Edition User Guide.                                                                                                                           | No                         |
     | drc_password        | The password of the `drc user`.                                                                                                                                                                                                                                                                                   | No                         |
     | cm_url              | The URL of the OMS Community Edition CM service. Example: <http://10.10.10.1:8088>.  <br>**Note:** <br> In single-node deployment mode, the IP address of the server where OMS is deployed is used. We recommend that you do not set it to `http://127.0.0.1:8088`.                                              | Yes                          |
     | cm_location         | The code of the region. Value range: \[0,127\]. You can select one number for each region.                                                                                                                                                                                                                        | Yes                          |
     | cm_region           | The name of the region. Example: cn-jiangsu. <br> **Notice:**<br>  If you use OMS Community Edition with the Alibaba Cloud Multi-Site High Availability (MSHA) service in an active-active disaster recovery scenario, use the region configured for the Alibaba Cloud service.                              | No                           |
     | cm_region_cn        | The region name in Chinese. Example: 江苏.                                                                                                                                                                                                                                                                          | No                           |
     | cm_nodes            | The IP addresses of servers on which the OMS Community Edition CM service is deployed.                                                                                                                                                                                                                                              | Yes                          |
     | cm_is_default       | Indicates whether the OMS Community Edition CM service is enabled by default.                                                                                                                                                                                                                                                       | No. Default value: `true`    |
     | tsdb_enabled        | Indicates whether metric reporting is enabled for monitoring. Valid values: `true` and `false`.                                                                                                                                                                                                                   | No. Default value: `false`   |
     | tsdb_service        | The type of the time-series database. Valid values: `INFLUXDB` and `CERESDB`.                                                                                                                                                                                                                                     | No. Default value: `CERESDB` |
     | tsdb_url            | The IP address of the server where InfluxDB is deployed. You need to modify this parameter based on the actual environment if you set the `tsdb_enabled` parameter to `true`.                                                                                                                                     | No                           |
     | tsdb_username       | The username used to connect to the time-series database. You need to modify this parameter based on the actual environment if you set the `tsdb_enabled` parameter to `true`.  After you deploy the time-series database, you must manually create a user and specify the username and password. | No                           |
     | tsdb_password       | The password used to connect to the time-series database. You need to modify this parameter based on the actual environment if you set the `tsdb_enabled` parameter to `true`.                                                                                                                                    | No                           |

   * The following example describes a template of the `config.yaml` file:

     ```yaml
     oms_meta_host: 10.10.10.1
     oms_meta_port: 2883
     oms_meta_user: root@oms#obcluster
     oms_meta_password: oms
     drc_rm_db: oms_rm
     drc_cm_db: oms_cm
     drc_cm_heartbeat_db: oms_cm_heartbeat
     drc_user: drc_user_name
     drc_password: 'OceanBase#oms'
     cm_url: http://10.10.10.2:8088
     cm_location: 100
     cm_region: cn-anhui
     cm_region_cn: Anhui
     cm_is_default: true
     cm_nodes:
      - 10.10.10.2
     tsdb_service: 'INFLUXDB'
     tsdb_enabled: true
     tsdb_url: '10.10.10.4:8086'
     tsdb_username: username
     tsdb_password: 123456
     ```

4. Load the downloaded OMS Community Edition image file to the local image repository of the Docker container.

   ```shell
   docker load -i <The storage path of the OMS Community Edition image>
   ```

5. Run the following command to start the container.

   You can access the OMS Community Edition console by using an HTTP or HTTPS URL. To securely access the OMS Community Edition console, install an SSL certificate and mount it to the specified directory in the container. The certificate is not required for HTTP access.

   ```shell
   OMS_HOST_IP=xxx
   CONTAINER_NAME=oms_xxx
   IMAGE_TAG=feature_x.x.x_ce
   
   docker run -dit --net host \
   -v /data/config.yaml:/home/admin/conf/config.yaml \
   -v /data/oms/oms_logs:/home/admin/logs \
   -v /data/oms/oms_store:/home/ds/store \
   -v /data/oms/oms_run:/home/ds/run \
   # If you mount the SSL certificate in the OMS container, you must set the following two parameters.
   -v /data/oms/https_crt:/etc/pki/nginx/oms_server.crt 
   -v /data/oms/https_key:/etc/pki/nginx/oms_server.key
   -e OMS_HOST_IP=${OMS_HOST_IP} \
   --privileged=true \
   --pids-limit -1 \
   --ulimit nproc=65535:65535 \
   --name ${CONTAINER_NAME} \
   reg.docker.alibaba-inc.com/oceanbase/oms:${IMAGE_TAG} 
   ```

   |           Parameter            |                                                                                                         Description                                                                                                      |
   |--------------------------------|--------------------------------------------------------------------------------------|
   | OMS_HOST_IP                    | The IP address of the host.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | CONTAINER_NAME                 | The name of the container.                                                                                                                                                                                                                                                                                                                                           |
   | IMAGE_TAG                      | The tag of the image. To view the image tag, execute the `docker images` statement after you load the image on the host.                                                                                                  |
   | /data/oms/oms_logs<br>  /data/oms/oms_store  <br>   /data/oms/oms_run         | You can replace `/data/oms/oms_logs`, `/data/oms/oms_store`, and `/data/oms/oms_run` with the mount directories created on the server where OMS is deployed. The mount directories store the logs generated during the operating of OMS and generated by stores and synchronization components, respectively, to persistently retain the logs on the server.  **Notice**  The mount directories must remain unchanged during subsequent redeployment or upgrades. |
   | /home/admin/logs  <br>/home/ds/store <br>  /home/ds/run           | `/home/admin/logs`, `/home/ds/store`, and `/home/ds/run` are default directories in the container and cannot be modified.                                                                                                                                                                                                                                                                                                                                                                         |
   | /data/oms/https_crt (optional)<br> /data/oms/https_key (optional) | The mount directory of the SSL certificate in the OMS Community Edition container. Specify the directory based on your actual configurations.  If you mount an SSL certificate, the NGINX service in the OMS Community Edition container runs in HTTPS mode. In this case, you can access the OMS Community Edition console by using only the HTTPS URL.                                                                                                                                                                                |
   | privileged                     | Specifies whether to grant the container scaling privilege.                                                                                                                                                                                                                                                                                                                                                                                                                                       |
   | pids-limit                     | Specifies whether to limit the number of container processes. The value -1 indicates that the number is unlimited.                                                                                                                                                                                                                                                                                                                                                                                |
   | ulimit nproc                   | The maximum number of user processes.                                                                                                                                   |

6. Access the new container.

   ```shell
   docker exec -it  ${CONTAINER_NAME} bash  
   ```

   **Notice**

   `CONTAINER_NAME` represents the name of the container.

7. Perform metadata initialization in the root directory.

   ```shell
   bash /root/docker_init.sh
   ```

   After you run the command, the following initialization process is performed:

   1. Initialize the data in the MetaDB.

   2. Generate configuration files for respective components.

   3. Restart all components.

   4. Initialize OMS Community Edition resource tags and resource groups.

   In the execution of the `docker_init.sh` script, pay attention to the output of command lines. When the execution is completed, the following message is displayed: **[Completed] All initialization steps are executed**.

   **Notice:**

   The execution takes 2 to 4 minutes to complete. Be patient and do not interrupt the process.

   When you set a MySQL tenant of OceanBase Database as the MetaDB, the following error may occur: `ERROR 1235 (0A000): Modify large text/lob column not supported`, which can be ignored.

   The `docker_init.sh` script outputs the following information:

   ```shell
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   # [Step 1] Verify the config.yaml configuration file.
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   python -m omsflow.scripts.units.oms_cluster_config --check /home/admin/conf/config.yaml
   
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   # [Step 2] Create the OMS MetaDB.
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   python -m omsflow.scripts.units.oms_init_manager --init-db
   
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   # [Step 3] Create the configuration files for OMS components.
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   python -m omsflow.scripts.units.oms_init_manager --init-config-file
   
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   # [Step 4] Restart all OMS components. This step takes about two minutes to complete.
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   supervisorctl restart crond nginx oms_console oms_drc_cm oms_drc_supervisor sshd
   supervisorctl status crond nginx oms_console oms_drc_cm oms_drc_supervisor sshd
   supervisorctl status crond nginx oms_console oms_drc_cm oms_drc_supervisor sshd
   
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   # [Step 5] Initialize OMS resource tags and resource groups.
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   python -m omsflow.scripts.units.oms_cluster_manager add_resource
   
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   # [Completed] All initialization steps are executed.
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   ```
