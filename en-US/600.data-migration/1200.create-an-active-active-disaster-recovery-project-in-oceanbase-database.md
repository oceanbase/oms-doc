# Active-active disaster recovery within OceanBase Database Community Edition

OceanBase Migration Service (OMS) Community Edition allows you to migrate data between multiple regions and create active-active disaster recovery projects.

## Background information

As more users apply OMS Community Edition in data migration, OMS Community Edition must adapt to increasingly diverse scenarios. In addition to single-region data migration and data synchronization, OMS Community Edition supports data migration across regions and regular or active-active data synchronization across regions.

OMS Community Edition supports the following active-active disaster recovery scenarios:

* Local data migration and synchronization

* Local primary/standby disaster recovery

* Local active-active disaster recovery

* Remote data migration and synchronization

* Remote primary/standby disaster recovery

* Remote active-active disaster recovery

Primary/Standby disaster recovery is common in scenarios with data disaster recovery requirements. You can create a project to synchronize data in real time between the primary and standby IDCs based on OMS Community Edition. When the primary IDC encounters a disaster or is down, the business can be switched to the standby IDC to avoid business interruption.

However, primary/standby disaster recovery causes a waste of resources in the standby IDC. Therefore, OMS Community Edition provides an active-active solution to allow two IDCs to share business traffic.

In active-active disaster recovery within OceanBase Database Community Edition, no forward switchover is performed, and you can enable DDL parameters only for one link.

## Prerequisites

* You have created a corresponding schema in the destination database. OMS Community Edition allows you to migrate tables and columns. Therefore, you must create a corresponding schema in the destination database before migration.

* You have created dedicated database users for data migration in the source and destination databases, and granted corresponding privileges to the users. For more information, see [Create a database user](../800.create-and-manage-data-sources/300.create-a-database-user.md).

## Limitations

* **Limitations on the source database**

   **Do not perform DDL operations for database or schema changes during schema migration or full data migration. Otherwise, the data migration project may be interrupted.**

* In active-active disaster recovery within OceanBase Database Community Edition, only tables with unique keys can be migrated.

* When you create an active-active disaster recovery project, you cannot select reverse incremental migration.

* If the destination is a database, OMS Community Edition does not support triggers in the destination database. If triggers exist in the destination database, the data migration may fail.

* You must create a forward link and a reverse link to form an active-active disaster recovery link, which does not support triggers.

* You can enable synchronization of DDL operations for incremental migration in either the forward or reverse link.

* When `useTargetSchema` is set to `false` in incremental synchronization, **if the destination uses a field of the BINARY type as the primary key or unique key, and the length of the data at the source is different from the length of the field of the BINARY type at the destination, no data is matched for the UPDATE or DELETE operation. This causes data quality risks.**

* The data source identifiers and user accounts must be globally unique in OMS Community Edition.

* OMS Community Edition supports the migration of only objects whose database name, table name, and column name are ASCII-encoded without special characters. The special characters are line breaks and . | " ' ` ( ) = ; / &

* If temporary tables exist in OceanBase Database Community Edition of a version earlier than V4.0.0, full migration fails.

* The source cannot be a standby OceanBase database.

## Considerations

* If you use OceanBase Database Community Edition V4.x, we recommend that you enable log archiving. If you enable log archiving, OMS Community Edition implements incremental synchronization by consuming archive logs after clogs are recycled. For more information about how to enable log archiving, see the [Log archive](https://www.oceanbase.com/docs/community-observer-cn-10000000000901781) chapter.

* If the UTF-8 character set is used in the source, we recommend that you use a compatible character set, such as UTF-8 or UTF-16, in the destination to avoid garbled characters.

* If the clocks between nodes or between the client and the server are out of synchronization, the latency may be inaccurate during incremental synchronization or reverse incremental migration.

   For example, if the clock is earlier than the standard time, the latency can be negative. If the clock is later than the standard time, the latency can be positive.

* In an active-active disaster recovery project within OceanBase Database Community Edition, if the source database is of a version earlier than V3.2.x and contains a multi-partition table that has a globally unique index, data may be lost during migration if you update the value of the partitioning key of the table.

* Check whether the migration precision of OMS Community Edition for columns of data types such as DECIMAL, FLOAT, and DOUBLE is as expected. If the precision of the destination field type is lower than the precision of the source field type, the value with a higher precision may be truncated. This may result in data inconsistency between the source and destination fields.

* When DDL synchronization is disabled, if you change the unique index of the destination, you must restart the Incr-Sync component. Otherwise, the data may be inconsistent.

* In a multi-table aggregation scenario:

  * We recommend that you map objects in the source and destination by importing objects and configuring matching rules.

  * We recommend that you manually create schemas at the destination. If you use OMS Community Edition to create schemas, skip failed objects in the schema migration step.

* In a data migration project where the source is OceanBase Database Community Edition and DDL synchronization is enabled, if a RENAME operation is performed on a table in the source, we recommend that you restart the project to avoid data loss during incremental synchronization.

* By default, `lower_case_table_names` is set to `1` at the destination, and the destination database objects are created with lowercase names.

## Create a forward link

1. Create a data migration project.

   1. Log on to the console of OMS Community Edition.

   2. In the left-side navigation pane, click **Data Migration**.

   3. On the **Data Migration** page, click **Create Migration Project** in the upper-right corner.

2. On the **Select Source and Destination** page, configure the parameters.

   | Parameter | Description |
   |--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | Migration Project Name | We recommend that you set it to a combination of digits and letters. It must not contain any spaces and cannot exceed 64 characters in length.  |
   | Tag | Click the field and select a target tag from the drop-down list. You can also click **Manage Tags** to create, modify, and delete tags. For more information, see [Use tags to manage data migration projects](1500.manage-data-migration-projects/300.use-tags-to-manage-data-migration-projects.md).  |
   | Source | If you have created a data source of OceanBase Database Community Edition, select it from the drop-down list. If not, click **New Data Source** in the drop-down list and create one in the dialog box that appears on the right. For more information about parameters, see [Create a data source of OceanBase Database Community Edition](../800.create-and-manage-data-sources/100.create-a-data-source/100.add-an-oceanbase-ce-data-source.md).  |
   | Destination | If you have created a data source of OceanBase Database Community Edition, select it from the drop-down list. If not, click **New Data Source** in the drop-down list and create one in the dialog box that appears on the right.  |
   | Scenarios | Two scenarios are available: **Data Migration** and **Active-Active Disaster Recovery**. Select **Active-Active Disaster Recovery**.  <br>**Notice** <ul><li> The source and destination data sources must be tenants of the same type in OceanBase Database.   <li> The source and destination nodes must belong to different regions.  </ul> |

3. Click **Next**.

4. In the dialog box that appears, click **OK**.

   Note that this project supports only tables with a primary key or a non-null unique index. Other tables and views are automatically filtered out.

5. On the **Select Migration Type** page, configure the parameters.

   Migration types available for the forward link include **Schema Migration**, **Full Migration**, **Incremental Synchronization**, and **Full Verification**.

   | Migration type | Description |
   |------|---------------------------------------------------------------------------------------------------------|
   | Schema migration | The definitions of data objects, such as tables, indexes, constraints, comments, and views, are migrated from the source database to the destination database. Temporary tables are automatically filtered out.  |
   | Full migration | The existing data is migrated from tables in the source database to the corresponding tables in the destination database. If you select **Full Migration**, we recommend that you collect the statistics of the source database before data migration.  |
   | Incremental synchronization | Changed data in the source database is synchronized to the corresponding tables in the destination database after an incremental synchronization task starts. Data changes are data addition, modification, and deletion. <br>Options for **Incremental Synchronization** are [DML Synchronization](../600.data-migration/1600.migration-function-introduction/100.migration-dml.md) and [DDL Synchronization](../600.data-migration/1600.migration-function-introduction/200.migration-ddl.md). You can select the options as needed. For more information about DDL synchronization, see [Supported DDL operations in incremental migration between MySQL tenants of OceanBase Database](../600.data-migration/1700.supported-ddl-operations-for-incremental-migration-and-limits/300.obmysql-to-obmysql.md). **Incremental Synchronization** has the following limitations: <ul><li>You can enable DDL synchronization in either the forward or reverse link.  <li> If you select **DDL Synchronization**, when you perform a DDL operation in the source database that cannot be synchronized by OMS Community Edition, data migration may fail.    <li> If the DDL operation creates a new column, we recommend that you set the attribute of the column to Null. Otherwise, data migration may be interrupted.  </ul> |
   | Full verification | After the full data migration and incremental data synchronization are completed, OMS Community Edition automatically initiates a full data verification task to verify the data tables in the source and destination databases. <ul><li> If you select **Full Verification**, we recommend that you collect the statistics of both the source and destination databases before full verification. For more information, see [Manually collect statistics](https://www.oceanbase.com/docs/common-oceanbase-database-cn-10000000001699693).    <li> If you select **Incremental Synchronization** but do not select all DML operations in the **DML Synchronization** section, you cannot select **Full Verification**.   </ul> |

6. (Optional) Click **Next**.

   Specify the related information for the source OceanBase database.

   * For incremental synchronization, specify the ConfigUrl, username, and password.

   * For schema migration, specify the username and password.

   * For the migration of a table without a unique key, specify the password of `_OCEANBASE_INNER_DRC_USER`.

   If you have selected **Scheme Migration** or **Incremental Synchronization** but no related parameters are configured for the data source of the source database, the **More about Data Sources** dialog box appears, prompting you to configure related parameters. For more information about parameters, see [Create a data source of OceanBase Database Community Edition](../800.create-and-manage-data-sources/100.create-a-data-source/100.add-an-oceanbase-ce-data-source.md).

   After you configure the parameters, click **Test Connectivity**. After the test succeeds, click **Save**.

7. Click **Next**. On the **Select Migration Objects** page, select the migration objects and migration scope.

   You can select **Specify Objects** or **Match Rules** to specify the migration objects.

   * Select **Specify Objects**. Then select the objects to be migrated on the left and click **\>** to add them to the list on the right. You can select tables and views of one or more databases as the migration objects.

      <main id="notice" type='notice'>
      <h4>Notice</h4>
      <ul>
      <li>
      <p>The names of tables to be migrated, as well as the names of columns in the tables, must not contain Chinese characters. </p>
      </li>
      <li>
      <p>If the database or table name contains a double dollar sign ($$), you cannot create the migration project. </p>
      </li>
      <li>
      <p>After you select migration objects by using the <b>Specify Objects</b> option, the DDL operations take effect only for selected objects, and table creation is not supported. </p>
      </li>
      </ul>
      </main>

      OMS Community Edition also allows you to import objects from text, rename objects, set row filters, view column information, and remove a single migration object or all migration objects.

      | Operation | Step |
      |---------|---------------------------------------------------------------------------------------------------|
      | Import Objects | <ol><li> In the list on the right of the **Specify Migration Scope** section, click **Import Objects** in the upper-right corner.    <li>In the dialog box that appears, click **OK**.<br>  **Notice**<br>This operation will overwrite previous selections. Proceed with caution.   <li>In the **Import Objects** dialog box, import the objects to be migrated. <br>You can import CSV files to rename databases/tables and set row filtering conditions. For more information, see [Download and import the settings of migration objects](../600.data-migration/1500.manage-data-migration-projects/400.download-and-import-the-settings-of-migration-objects.md).    <li> Click **Validate**.    <li> After the validation succeeds, click **OK**. </ol> |
      | Rename | OMS Community Edition allows you to rename migration objects. For more information, see [Rename a database table](../600.data-migration/1600.migration-function-introduction/500.db-table-rename.md).  |
      | Settings | OMS Community Edition allows you to filter rows by using `WHERE` conditions. For more information, see [Use SQL conditions to filter data](../600.data-migration/1600.migration-function-introduction/600.migration-row-filters.md). <br>You can also view column information of the migration object in the **View Column** section.  |
      | Remove/Remove All | OMS Community Edition allows you to remove a single object or all objects to be migrated to the destination database during data mapping.  <ul><li>To remove a single migration object:<br>In the list on the right of the **Specify Migration Scope** section, hover the pointer over the target object, and click **Remove**.   <li> To remove all migration objects:<br>In the list on the right of the **Specify Migration Scope** section, click **Remove All** in the upper-right corner. In the dialog box that appears, click **OK**.   </ul> |

   * Select **Match Rules**. For more information, see [Configure matching rules for migration objects](../600.data-migration/1600.migration-function-introduction/300.configure-matching-rules-for-migration-objects.md).

8. Click **Next**. On the **Migration Options** page, specify the following parameters.

   To view or modify parameters of the Full-Import or Incr-Sync component, click **Configuration Details** in the upper-right corner of the **Full Migration** or **Incremental Synchronization** section. For more information about the parameters, see [Coordinator](../1100.o-m-guide/500.component-parameters/100.coordinator.md).

   * Schema migration

      This section is displayed only when you have selected **Schema Migration** on the **Select Migration Type** page, the source database is OceanBase Database Community Edition of a version earlier than V4.0.0, and the destination database is OceanBase Database Community Edition V4.0.0 or later. You can specify the **Character Set Mapping** and **Collation Mapping** parameters as needed.

   * Full migration

      The following table describes the full migration parameters, which are displayed only when you have selected **Full Migration** on the **Select Migration Type** page.

      | Parameter | Description |
      |----|----------------------------------|
      | Concurrency Speed | Valid values: **Stable**, **Normal**, **Fast**, and **Custom**. The amount of resources to be consumed by a full data migration task varies based on the migration performance. If you select **Custom**, you can set **Read Concurrency**, **Write Concurrency**, and **JVM Memory** as needed.  |
      | Processing Strategy When Records Exist in Target Object | Valid values: **Ignore** and **Stop Migration**.<ul><li>If you select **Ignore**, the data in the source and destination databases may be inconsistent. </li><li>If you select **Stop Migration**, the project is set to the Failed state when the system detects records in the destination table. To continue data migration, manually resume the project. </li> </ul> |
      | Whether to Allow Post-indexing | Specifies whether to create indexes after the full migration is completed. Post-indexing can shorten the time required for full migration. For more information about the considerations on post-indexing, see the description below. <main id="notice" type='notice'><h4>Notice</h4><p>This feature is supported only when you have selected both <b>Schema Migration</b> and <b>Full Migration</b> on the <b>Select Migration Type</b> page. </p> </main> |

      If post-indexing is allowed, we recommend that you adjust the parameters based on the hardware conditions of the destination database and the business traffic.

      * If you use OceanBase Database Community Edition V4.x, adjust the following parameters of the sys tenant and business tenants by using a command-line interface (CLI) client.

         * Adjust the parameters of the sys tenant

            ```sql
            // parallel_servers_target specifies the queuing conditions for parallel queries on each server. 
            // To maximize performance, we recommend that you set this parameter to a value greater than, for example, 1.5 times, the number of physical CPU cores. In addition, make sure that the value does not exceed 64, to prevent database kernels from contending for locks. 
            set global parallel_servers_target = 64; 
            ```

         * Adjust the parameters of a business tenant

            ```sql
            // Specify the limit on the file memory buffer size.
            alter system set _temporary_file_io_area_size = '10' tenant = 'xxx'; 
            // Disable throttling in V4.x.
            alter system set sys_bkgd_net_percentage = 100;  
            ```

      * If you use OceanBase Database Community Edition V3.x, adjust the following parameters of the sys tenant by using a CLI client.

         ```sql
         // parallel_servers_target specifies the queuing conditions for parallel queries on each server. 
         // To maximize performance, we recommend that you set this parameter to a value greater than, for example, 1.5 times, the number of physical CPU cores. In addition, make sure that the value does not exceed 64, to prevent database kernels from contending for locks. 
         set global parallel_servers_target = 64; 
         // data_copy_concurrency specifies the maximum number of concurrent data migration and replication tasks allowed in the system. 
         alter system set data_copy_concurrency = 200; 
         ```

   * Incremental synchronization

      The following table describes the incremental synchronization parameters, which are displayed only when you have selected **Incremental Synchronization** on the **Select Migration Type** page.

      | Parameter | Description |
      |----|----------------------------------|
      | Concurrency Speed | Valid values: **Stable**, **Normal**, **Fast**, and **Custom**. The amount of resources to be consumed by an incremental synchronization task varies based on the synchronization performance. If you select **Custom**, you can set **Read Concurrency**, **Write Concurrency**, and **JVM Memory** as needed.  |
      | Incremental Synchronization Start Timestamp | <ul><li> If you have set the migration type to **Full Migration**, this parameter is not displayed.    <li> If you have selected **Incremental Synchronization** but not **Full Migration**, specify a point in time after which the data is to be synchronized. The default value is the current system time. For more information, see [Set an incremental synchronization timestamp](../600.data-migration/1600.migration-function-introduction/1000.incremental-synchronization-timestamp.md).  |
      | Incremental Record Retention Time | The duration that incremental parsed files are cached in OMS Community Edition. A longer retention period results in more disk space occupied by the Store component of OMS Community Edition.  |

9. Click **Precheck** to start a precheck on the data migration project.

During the precheck, OMS Community Edition checks the read and write privileges of the database users and the network connectivity of the databases. The data migration project can be started only after it passes all check items. If an error is returned during the precheck:

* You can identify and troubleshoot the problem and then perform the precheck again.

* You can also click **Skip** in the **Actions** column of the failed precheck item. A dialog box appears, prompting you the impact. If you want to skip this operation, click **OK**.

10. Click **Start Project**. If you do not need to start the project now, click **Save** to go to the details page of the data migration project. You can start the project later as needed.

   OMS Community Edition allows you to modify the migration objects when the migration project is running. For more information, see [View and modify migration objects](../600.data-migration/1500.manage-data-migration-projects/200.view-and-modify-migration-objects.md). After a data migration project is started, the migration subtasks will be executed based on the selected migration types. For more information, see the "View migration details" section in the [View details of a data migration project](../600.data-migration/1500.manage-data-migration-projects/100.view-details-of-a-data-migration-project.md) topic.

## Create a reverse link

You can create a reverse link only after the schema migration task on the forward link is completed.

1. On the **Data Migration** page, click **Create Migration Project** in the upper-right corner.

2. On the **Select Source and Destination** page, configure the parameters.

3. Click **Next**.

4. In the dialog box that appears, click **OK**.

   Note that this project supports only tables with a primary key or a non-null unique index and other tables are automatically filtered out.

5. On the **Select Migration Type** page, configure the parameters.

   For the reverse link, set **Migration Type** to **Incremental Synchronization**.

   <main id="notice" type='notice'>
    <h4>Notice</h4>
    <p>You can enable DDL synchronization in either the forward or reverse link. </p>
   </main>

6. (Optional) Click **Next**.

   For incremental synchronization, specify the ConfigUrl, username, and password of the source database. For the migration of a table without a unique key, you need to specify the password of `_OCEANBASE_INNER_DRC_USER`.

   If no related parameters are configured for the source database, the **More about Data Sources** dialog box appears, prompting you to configure related parameters. For more information about parameters, see [Create a data source of OceanBase Database Community Edition](../800.create-and-manage-data-sources/100.create-a-data-source/100.add-an-oceanbase-ce-data-source.md).

   After you configure the parameters, click **Test Connectivity**. After the test succeeds, click **Save**.

7. Click **Next**. On the **Select Migration Objects** page, select the migration objects and migration scope.

   When you create a reverse link, OMS Community Edition also allows you to import objects from text, rename objects, set row filters, view column information, and remove a single migration object or all migration objects. For more information, see the section that describes how to create a forward link.

8. Click **Next**. On the **Migration Options** page, specify the following parameters.

9. Click **Precheck** to start a precheck on the data migration project.

10. Click **Start Project** to start the incremental synchronization task for the project.
