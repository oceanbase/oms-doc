# 概述

本文为您介绍升级 OceanBase 迁移服务（OceanBase Migration Service，OMS）社区版至 3.3.1-CE 版本的背景信息和升级限制。

## 背景信息

OMS 社区版的升级具备回滚功能。强烈建议您在开始升级前，通过备份工具将旧数据库（例如 db_oms）备份为 SQL 文件（例如 db_oms_bak.sql）。新的 OMS 社区版镜像仍会运行在旧数据库（db_oms）上，备份出的数据库文件在回滚时使用。

>**说明：**
>
>如果您没有合适的备份工具，请联系 OMS 社区版技术支持人员提供备份操作文档。通常使用 mysqldump 进行导出即可。

升级流程如下：

1. 如果开启了 HA 功能，请先关闭 HA。

    >**说明：**
    >
    >OMS 社区版从 3.3.1-CE 版本开始支持 HA 功能。如果您使用的是 OMS 3.3.1-CE 以下版本，请忽略 HA 相关操作。

2. 备份数据库。

3. 启动 OMS 社区版 3.3.1-CE 版本的新容器。

   OMS 社区版 3.3.1-CE 版本新容器使用的 meta 库需要与升级前的 meta 库保持一致，以及三个挂载盘的路径也需要与升级前保持完全一致。

4. 在 **系统参数** 页面，开启 HA 功能，并设置相关参数。

5. （可选）根据业务需求，进行回滚操作。

## 升级限制

* OMS 社区版仅支持升级目标版本的上一个版本，升级路径为 3.2.2-CE > 3.3.0-CE > 3.3.1-CE。
  
* 请在升级版本之前，确保数据迁移、数据同步项目基本实时，且建议项目已执行完正向切换步骤，不建议将其延后至 OMS 社区版新版本上执行。

* OMS 社区版 3.2.2-CE 版本在升级前，需要在 Connector 中新增 `dbType` 配置项之后再升级。如果您在升级前未新增该配置，会导致项目无法运行，请在升级后进行修复。升级后的修改详情请参见 [如何处理 OMS 社区版 3.2.2-CE 版本升级至 3.3.1-CE 版本的配置兼容问题](../7.upgrade-guide/4.faq.md)。
  
  >**注意：**
  >
  >如果您使用的是 OMS 社区版 3.3.0-CE 版本，但存在 OMS 社区版 3.2.2-CE 版本中创建的数据同步项目，则有可能存在上述问题。您可以使用相同的方式进行修复。
  >
  >判断依据主要是看 Connector 组件的 Source config 中是否存在 `dbType` 或 `db_type` 参数。如果存在任意一个参数，则无需修复。

  操作步骤如下：

    1. 登录 OMS 社区版控制台。

    2. 在左侧导航栏，单击 **运维监控** > **组件** > **Connector**。

    3. 在 **Connector** 页签下，单击 Connector 操作列的 **更新**。
  
    4. 在 **更新配置** 对话框，鼠标悬停至 **Source** 右侧的空白区域，单击显示的 **+** 图标，新增 `dbType` 配置项。

        ![更新 Connector](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E6%9B%B4%E6%96%B0%20Connector%20%282%29.png)

    5. 配置完成后，单击 **更新**。

  如果机器上只存在一种源端数据库，您可以进行如下操作：
  
    1. 单击 Connector 页签右上角的 **批量运维**。

    2. 在 **批量运维** 对话框，单击 **更新**。

    3. 选择 IP 后，鼠标悬停至 **配置** > **Source** 右侧的空白区域，单击显示的 **+** 图标，新增配置 `dbType` 配置项。

        ![批量运维](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E6%89%B9%E9%87%8F%E8%BF%90%E7%BB%B4.png)  

    4. 配置完成后，单击 **提交**。
