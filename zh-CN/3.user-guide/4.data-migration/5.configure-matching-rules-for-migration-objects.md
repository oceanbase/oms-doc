# 配置迁移对象的匹配规则

本文为您介绍迁移对象匹配规则的背景信息、使用限制、配置方式及 OceanBase 迁移服务（OceanBase Migration Service，OMS）社区版支持的通配符规则。

## 背景信息

您在创建数据迁移项目时，指定了具体的数据迁移对象。OMS 社区版支持增量 DDL 后，如果在迁移过程中源端创建了新表，则会由于该表未在指定的数据迁移对象中，导致无法同步该表的数据。

通配符使用一种很短的文本模式，简洁地代表一组路径。您可以将通配符看作原始的正则表达式，使用简单且方便。您在创建数据迁移项目时，可以使用基于通配规则的方式配置数据迁移对象，详情请参见本文《通配符规则说明》模块的内容。

目前 OMS 社区版支持所有类型的数据迁移项目配置迁移对象规则和排除对象规则，并适用于数据迁移项目执行的所有阶段。创建的数据迁移项目仅支持在启动前更新迁移对象规则和排除对象规则的配置。

>**注意：**
>
>如果您在创建数据迁移项目时，选择了 **结构变更 DDL**，则必须使用基于通配规则的方式配置数据迁移对象。

创建数据迁移项目时，通配迁移对象规则和排除对象规则支持以下功能：

* 支持以通配规则的方式指定迁移对象。

* 支持编辑、校验匹配规则，以及预览匹配对象。

* 每次更新预览，支持展示同上次通配规则匹配结果之间对象的增减信息。

* 通配规则下，支持配置库名映射和表名映射。

## 使用限制

* 表的迁移对象规则不允许为空。

* 如果存在 Schema 多到一映射，不支持反向增量同步。

* 如果存在多表汇聚，不支持反向增量同步。

* 如果存在 DML 过滤，不支持全量校验。

* 结构迁移和全量迁移之间的时间段内，不允许源端发生 DDL。

* 迁移对象规则和排除对象规则支持指定具体表，但不支持 DDL 同步功能。

* 在执行修改表名称的 DDL 时，不允许将排除对象规则中的表重命名为排除对象规则之外的名称。

* 如果使用 gh-ost 将 MySQL 数据库的增量 DDL 同步至 OceanBase 社区版，请务必配置 **排除对象规则** 为 `{database_name}.*_ghc`。

## 配置匹配规则

1. 新建迁移项目。

   1. 登录 OMS 社区版控制台。

   2. 在左侧导航栏，单击 **数据迁移**。

   3. 在 **数据迁移** 页面，单击右上角的 **新建迁移项目**。

2. 在 **选择源和目标** 页面，配置各项参数。详情请参见相应类型的创建数据迁移项目文档。

   |   参数   |                                                        描述                                             |
   |--------|-------------------------------------------------------------------------------------------------------------------|
   | 迁移项目名称 | 建议使用中文、数字和字母的组合。名称中不能包含空格，长度不得超过 64 个字符。                                                                    |
   | 标签     | 单击文本框，在下拉列表中选择目标标签。您也可以单击 **管理标签**，进行新建、修改和删除。详情请参见 [通过标签管理数据迁移项目](../4.data-migration/4.manage-data-migration-projects/5.use-tags-to-manage-data-migration-projects.md)。 |
   | 源端    | 选择已创建的源端数据源。                                                                                                      |
   | 目标端   | 选择已创建的目标端数据源。                                                                                                     |

3. 单击 **下一步**。

4. （可选）单击弹出提示框中的 **我知道了**。

5. 在 **选择迁移类型** 页面，配置各项参数。

6. （可选）单击 **下一步**。

7. 单击 **下一步**，在 **选择对象** 页面，选择迁移对象和迁移范围。

      您可以通过 **指定对象** 和 **匹配规则** 两个入口选择迁移对象，本文仅为您介绍如何配置匹配规则。

      1. 勾选 **匹配规则**。

      2. 在 **选择迁移范围** 区域，输入 **迁移对象规则** 和 **排除对象规则**（可选）。支持的匹配规则详情请参见本文《通配符规则说明》模块的内容。

         >**注意：**
         >
         >如果使用 gh-ost 将 MySQL 数据库的增量 DDL 同步至 OceanBase 社区版，则 **排除对象规则** 为必选，请务必将其配置为 `{database_name}.*_ghc`。<br>请注意源端用户的权限设置问题。如果您授予用户的权限不足，部分对象未被 OMS 社区版从前端展示出来，会导致您不能正确配置匹配规则。因此您需要将未授予权限的对象加入 **排除对象规则**，以避免 OMS 社区版因无法找到目标端对象而造成数据迁移项目中断的问题。

         配置迁移对象规则和排除对象规则后，您可以在右侧查看可迁移对象和匹配结果。匹配结果包括最终对象、新增对象和减少对象。您填写的通配迁移对象规则和排除对象规则，会同时应用于表和视图。

         您还可以在 **最终对象** 页签，鼠标悬停至目标对象，单击弹出的 **重命名**，输入需要修改的名称后，单击 **确定**，对目标对象进行重命名操作。

      3. 单击 **校验并预览对象**。

8. 校验通过后，单击 **下一步**。

9. 在 **迁移选项** 页面，配置各项参数。详情请参见所选迁移类型对应的创建数据迁移项目文档。

10. 单击 **预检查**，系统对数据迁移项目进行预检查。

11. 单击 **启动项目**。

## 通配符规则说明

匹配规则支持正则表达式，"\*" 代替正则表达式中的 ".\*"。OMS 社区版支持的通配符规则包括 "\*"、"?"、"\[\]" 和 "\[!\]"，每条规则使用单行且每条规则前后不允许存在空格。

配置迁移对象规则和排除对象规则后，当源端创建一张新表时，只要其表名匹配迁移对象规则且不匹配排除对象规则，即可被 OMS 实时同步。

设置迁移对象规则和排除对象规则时，请注意区分大小写。如果匹配规则和对象名称的大小写不一致，则无法匹配出数据。

### 字符 "\*"

字符 "\*" 可以匹配任意长度的字符，也可以匹配空字符。您可以使用 "\*" 选择库或 Schema 中所有的对象。例如，设置 **迁移对象规则** 为 `<Schema>.*`，则右侧的 **匹配结果** 会显示该 Schema 下的所有表和视图。

![*](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%991.png)

您也可以在 **排除对象规则** 中，设置无需迁移的对象，单击 **校验**。校验通过后，单击 **预览对象**，即可在 **匹配结果** 中查看。

![排除](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%991.png)

### 字符 "?"

字符 "?" 可以匹配单个字符。如果匹配多个字符，则需要多个 "?" 连用。您可以使用 "?" 选择库或 Schema 中符合部分特征的对象。例如，设置 **迁移对象规则** 为 `<Schema>.t?`，则右侧的 **匹配结果** 会显示该 Schema 下符合该格式的表和视图。

>**注意：**
>
>字符 "?" 不能匹配空字符，即字符 "?" 占据的位置必须有字符存在。

![？](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%993.png)

您也可以在 **排除对象规则** 中，设置无需迁移的对象，单击 **校验**。校验通过后，单击 **预览对象**，即可在 **匹配结果** 中查看。

![排除对象](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%994.png)

### 字符 "\[\]"

字符 "\[\]" 可以匹配方括号中的任意一个字符，`[start-end]` 表示一个连续的范围。例如，设置 **迁移对象规则** 为 `<Schema>.[]*`，则右侧的 **匹配结果** 会显示该 Schema 下符合该格式的表和视图。

![\[\]](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%995.png)

您也可以在 **排除对象规则** 中，设置无需迁移的对象，单击 **校验** 。校验通过后，单击 **预览对象** ，即可在 **匹配结果** 中查看。

![排除\[\]](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%996.png)

### 字符 "\[!\]"

字符 "\[!\]" 表示匹配不在方括号中的字符（不包括空字符），`[!start-end]` 表示一个连续的范围。例如，设置 **迁移对象规则** 为 `<Schema>.[!]*`，则右侧的 **匹配结果** 会显示该 Schema 下符合该格式的表和视图。

![\[!\]](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%997.png)

您也可以在 **排除对象规则** 中，设置无需迁移的对象，单击 **校验** 。校验通过后，单击 **预览对象** ，即可在 **匹配结果** 中查看。

![排除\[!\]](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/oms/oms-enterprise/%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%998.png)
