# 创建 OceanBase 社区版的容灾双活项目

OceanBase 迁移服务（OceanBase Migration Service，OMS）社区版支持 OceanBase 社区版在多个地域之间进行数据迁移，并支持创建容灾双活项目。

## 背景信息

随着越来越多的用户使用 OMS 社区版进行数据迁移，OMS 社区版需要解决的用户场景也越来越丰富。除目前广泛使用的单地域数据迁移、数据同步场景外，OMS 社区版还支持在多个地域之间进行数据迁移，以及在异地城市之间进行数据同步或双活同步。

目前 OMS 社区版支持的容灾双活场景如下：

* 同城数据迁移和数据同步

* 同城主备容灾

* 同城双活

* 异地数据迁移和数据同步

* 异地主备容灾

* 异地双活

主备容灾常见于有数据容灾需求的场景中。基于 OMS 社区版创建主机房至备机房的同步链路（确保链路实时性），在主机房发生灾害、宕机等场景下，业务可以切换至备机房，避免产生业务影响。

但主备容灾容易造成备机房资源闲置浪费等问题。因此 OMS 社区版提供了双活的解决方案，即同时由两个机房来承担实际业务流量。

OceanBase 社区版的容灾双活数据迁移项目无正向切换步骤，且容灾双活数据迁移项目仅允许在一条链路中打开 DDL 参数。

## 前提条件

* 已在目标端 OceanBase 社区版创建对应的 Schema。OMS 社区版支持迁移表和列，您需要提前在目标端创建对应的 Schema。

* 已为源端和目标端 OceanBase 社区版创建专用于数据迁移项目的数据库用户，并为其赋予了相关权限。详情请参见 [创建数据库用户](../../2.users-and-privileges/1.create-a-database-user.md)。

## 使用限制

* OceanBase 社区版之间的容灾双活项目不支持迁移无主键表。

* 创建容灾双活项目时，不支持选择反向增量。

* 库到库长期同步中，OMS 社区版不支持目标端存在 Trigger。

* 开启增量 DDL 后，`drop index` 命名会无差别执行，可能导致目标端索引丢失。

* 一个数据迁移项目可以迁移多个 Schema。最大支持到同一租户级别，最小支持到某张表。

* 如果源端字符集为 UTF-8，目标端建议您使用 UTF-8 或大于 UTF-8 的字符集编码。

* 您需要创建两条链路（正向链路和反向链路）来组成容灾双活链路，且容灾双活链路不允许使用触发器 Trigger。

* 容灾双活链路中的正向链路和反向链路，只能有一个开启增量 DDL 同步。

* OceanBase 数据库的容灾双活项目中，当 OceanBase 社区版具有全局唯一索引的多分区表时，如果您更新了表的分区键的值，可能导致数据迁移过程中丢失数据。
  
* 迁移 OceanBase 社区版的数据至 OceanBase 社区版时，如果目标端的字段长度小于源端字段长度，本字段的数据会被数据库自动截断，造成源端和目标端的数据不一致。

## 创建正向链路

1. 新建数据迁移项目。

   1. 登录 OMS 社区版控制台。

   2. 在左侧导航栏，单击 **数据迁移**。

   3. 在 **数据迁移** 页面，单击右上角的 **新建迁移项目**。

2. 在 **选择源和目标** 页面，配置各项参数。

   |   参数   |                                                           描述                                                            |
   |--------|-------------------------------------------------------------------------------------|
   | 迁移项目名称 | 建议使用中文、数字和字母的组合。名称中不能包含空格，长度不得超过 64 个字符。                                                                                                                                                                                               |
   | 标签     | 单击文本框，在下拉列表中选择目标标签。您也可以单击 **管理标签**，进行新建、修改和删除。详情请参见 [通过标签管理数据迁移项目](../4.manage-data-migration-projects/5.use-tags-to-manage-data-migration-projects.md)。                                                |
   | 源端    | 如果您已创建 OceanBase-CE 数据源，请从下拉列表中进行选择。如果未创建，请单击下拉列表中的 **添加数据源**，在右侧对话框进行添加。参数详情请参见 [添加 OceanBase-CE 数据源](../../3.manage-data-sources/1.add-a-data-source/1.add-an-oceanbase-ce-data-source.md)。                                                                                     |
   | 目标端   | 如果您已创建 OceanBase-CE 数据源，请从下拉列表中进行选择。如果未创建，请单击下拉列表中的 **添加数据源**，在右侧对话框进行添加。                                                                                                                                                               |
   | 使用场景   | 包括 **数据迁移** 和 **容灾双活**，此处选择 **容灾双活**。 <br>**注意：** <br>源端和目标端必须属于不同的地域。   |

3. 单击 **下一步**。

4. 单击弹出提示框中的 **我知道了**。

   请注意目前本项目仅支持具有主键或者非空唯一索引的表，其它表会自动过滤。

5. 在 **选择迁移类型** 页面，配置各项参数。

   在正向链路中，您可以选择的 **迁移类型** 包括 **结构迁移**、**全量迁移**、**增量同步** 和 **全量校验**。

   | 迁移类型 |                                           使用限制                                         |
   |------|---------------------------------------------------------------------------------------------------------|
   | 全量迁移 | 如果选择 **全量迁移**，建议您在迁移数据前，收集源端 OceanBase 社区版的统计信息。      |
   | 增量同步 | **增量同步** 包括 **数据变更 DML**（`Insert`、`Delete`、`Update`）和 **结构变更 DDL**，您可以根据需求进行选择。增量 DDL 的详情请参见 [OB_MySQL_CE 到 OB_MySQL_CE 迁移项目增量 DDL 支持的范围](../2.supported-ddl-operations-for-incremental-migration-and-limits.md)。<br>**增量同步** 的使用限制如下： <ul><li> 容灾双活链路中的正向链路和反向链路，只能有一个开启增量 DDL 同步。   <li> 如果您未选择 **结构变更 DDL**，请进行 DDL 变更前，确保源端无变更，且增量 DML 数据已全部同步至目标端。然后在源端、目标端分别进行相关的 DDL 操作。    <li> 如果您选择了 **结构变更 DDL**，当源端数据库发生 OMS 未支持的增量 DDL 操作时，会存在数据迁移中断的风险。   <li> 如果您未选择 **结构变更 DDL**，对于迁移链路内表的 DDL 操作，请先在目标端数据源执行，否则存在数据迁移中断的风险。 </ul>   |
   | 全量校验 | <ul><li> 如果选择 **全量校验**，建议您在全量校验开始前，分别收集源端和目标端 OceanBase 社区版的统计信息。   <li> 如果您选择了 **增量同步**，且数据变更 DML 选项中未选择所有的 DML，则 OMS 不支持本场景下的全量数据校验。  </ul>                         |

6. （可选）单击 **下一步**。

   源端 OceanBase 数据源需要根据需求补充相应信息：

   * 增量同步需要输入 Configurl、用户名和密码。

   * 结构迁移需要输入用户名和密码。
  
   * 无唯一键表迁移需要输入 `_OCEANBASE_INNER_DRC_USER` 的密码。

   如果您选择了 **结构迁移** 或 **增量同步**，但源端数据源未配置相应参数，则会弹出 **数据源补充信息** 对话框，提醒您进行配置。参数详情请参见 [添加 OceanBase-CE 数据源](../../3.manage-data-sources/1.add-a-data-source/1.add-an-oceanbase-ce-data-source.md)。

   补充完成后，单击 **测试连通性**。测试连接成功后，单击 **保存**。

7. 单击 **下一步**，在 **选择对象** 页面，选择迁移对象和迁移范围。

   您可以通过 **指定对象** 和 **匹配规则** 两个入口选择迁移对象。如果您在选择迁移类型时，选择了 **结构变更 DDL**，则仅支持使用 **匹配规则** 的方式指定迁移对象。

   * 选择 **指定对象**，在左侧选中需要迁移的对象，单击 **\>**，将其添加至右侧列表中。您可以选择一个或多个库的表、视图作为迁移对象。

     >**注意：**
     >
     >* 待迁移的表名和其中的列名不能包含中文字符。
     >
     >* 当数据库的库名或表名存在 "$$" 字符时，会影响数据迁移项目的创建。

     迁移 OceanBase 社区版的数据至 OceanBase 社区版时，OMS 社区版支持通过文本导入对象、重命名对象名称、设置行过滤、查看列信息，以及移除单个或全部迁移对象。

     |   操作    |                                                    步骤                                                  |
     |---------|------------------------------------------------------------------------------------------------------------|
     | 导入对象    | <ol><li> 在 **选择迁移范围** 区域的右侧列表中，单击右上角的 **导入对象**。   <li>在对话框中，单击 **确定**。<br> **注意：**<br> 导入会覆盖之前的操作选择，请谨慎操作。  <li>在 **导入迁移对象** 对话框中，导入需要迁移的对象。 <br>您可以通过导入 CSV 文件的方式进行库表重命名、设置行过滤条件等操作。详情请参见 [下载和导入迁移对象配置](../4.manage-data-migration-projects/6.download-and-import-the-settings-of-migration-objects.md)。   <li> 单击 **检验合法性**。   <li> 通过合法性的检验后，单击 **确定**。</ol>    |
     | 重命名     | <ol><li> 在 **选择迁移范围** 区域的右侧列表中，鼠标悬停至目标对象。  <li> 单击显示的 **重命名**。   <li> 输入修改后的名称，单击 **确定**。  </ol>                                                                                               |
     | 设置      | OMS 社区版支持 `WHERE` 条件实现行过滤，以及查看列信息。<ol><li> 在 **选择迁移范围** 区域的右侧列表中，鼠标悬停至目标对象。   <li> 单击显示的 **设置**。   <li> 在 **设置** 对话框中，输入标准的 SQL 语句中的 `WHERE` 子句，来配置行过滤。其作用范围为 **全量迁移** + **增量同步**。<br> **注意：** <ul><li> 请对列名添加转义符（\`）。例如，\`col\`。 <li>只有满足 `WHERE` 条件的数据才会被同步至目标数据源，以实现数据的行过滤。     <li>如果开启 `where` 条件的行过滤，目前 CHAR 或 VARCHAR 类型会强制右 trim，可能造成 VARCHAR 的比较不准确，请谨慎使用。  </ul>    <li> 单击 **确定**。 <br>您也可以在 **查看列** 区域，查看迁移对象的列信息。 </ol>                                |
     | 移除/全部移除 | OMS 社区版支持在数据映射时，对暂时选中到目标端的单个或多个对象进行移除操作。 <ul><li>移除单个迁移对象 <br>在 **选择迁移范围** 区域的右侧列表中，鼠标悬停至目标对象，单击显示的 **移除**，即可移除该迁移对象。  <li> 移除全部迁移对象 <br>在 **选择迁移范围** 区域的右侧列表中，单击右上角的 **全部移除**。在对话框中，单击 **确定**，即可移除全部迁移对象。</ul>     |

   * 选择 **匹配规则**，详情请参见 [配置迁移对象的匹配规则](../5.configure-matching-rules-for-migration-objects.md)。

8. 单击 **下一步**，在 **迁移选项** 页面，配置各项参数。

   |参数|描述|
   |----|----------------------------------|
   |全量迁移并发速度|包括 **平稳**、**正常** 和 **快速**。全量迁移的性能不同，全量迁移任务所需要的资源也不同。 <br>您也可以通过修改具体 Checker 组件的配置，实现自定义并发参数。 <br>**注意**：<br> 在 **选择迁移类型** 页面选中 **全量迁移**，才支持设置该选项。 |
   |全量校验并发速度|包括 **平稳**、**正常** 和 **快速**。不同档位对源端和目标端的资源消耗不同。<br>您也可以通过修改具体 Checker 组件的配置，实现自定义并发参数。|
   |增量记录保存时间|OMS 社区版中增量解析文件缓存的时长。配置的保存时间越长，OMS 社区版 Store 组件需要消耗的磁盘空间越大。  |
   |全量迁移是否允许目标表非空|全量迁移允许目标表非空时，全量校验采用的是 `in` 模式进行数据校验。 <br>**注意**：<br>在 **选择迁移类型** 页面选中 **全量迁移**，才支持设置该选项。   |
   |是否允许索引后置|您可以设置是否允许全量数据迁移完成后再创建索引，索引后置能够减少全量迁移的时间。<br>**注意**：<ul><li>在 **选择迁移类型** 页面同时选中 **结构迁移** 和 **全量迁移**，才支持设置该选项。  <li>仅非唯一键索引支持后置创建。</ul>|

9. 单击 **预检查**，系统对数据迁移项目进行预检查。

   在 **预检查** 环节，OMS 社区版会检查数据库用户的读写权限、数据库的网络连接等是否符合要求。全部检查项目均通过后才能启动数据迁移项目。如果预检查报错，请排查并处理问题后，重新执行预检查，直至预检查成功。

10. 单击 **启动项目**。

    如果您暂时无需启动项目，请单击 **保存**，跳转至数据迁移项目的详情页面，您可以根据需要进行手动启动。如果您需要查看详情，请参见 [查看数据迁移项目的详情](../4.manage-data-migration-projects/1.view-details-of-a-data-migration-project.md)。

## 创建反向链路

待正向链路的结构迁移任务运行结束后，您才可以开始创建反向链路。

1. 在 **数据迁移** 页面，单击右上角的 **新建迁移项目**。

2. 在 **选择源和目标** 页面，配置各项参数。

3. 单击 **下一步**。

4. 单击弹出提示框中的 **我知道了**。

   请注意目前本项目仅支持具有主键或者非空唯一索引的表，其它表会自动过滤。

5. 在 **选择迁移类型** 页面，配置各项参数。

   在反向链路中，您只需要选择 **迁移类型** 为 **增量同步**。

   >**注意：**
   >
   >容灾双活链路中的正向链路和反向链路，只能有一个开启增量 DDL 同步。

6. （可选）单击 **下一步**。

   增量同步时，源端 OceanBase 数据源需要输入 Configurl、用户名和密码。如果迁移的是无唯一键表，还需要输入 `_OCEANBASE_INNER_DRC_USER` 的密码。

   如果源端数据源未配置相应参数，则会弹出 **数据源补充信息** 对话框，提醒您进行配置。参数详情请参见 [添加 OceanBase-CE 数据源](../../4.manage-data-sources/1.add-a-data-source/1.add-an-oceanbase-ce-data-source.md)。

   补充完成后，单击 **测试连通性**。测试连接成功后，单击 **保存**。

7. 单击 **下一步**，在 **选择对象** 页面，选择迁移对象和迁移范围。

   创建反向链路时，OMS 社区版同样支持通过文本导入对象、重命名对象名称、设置行过滤、查看列信息，以及移除单个或全部迁移对象。详情请参见创建正向链路部分的描述。

8. 单击 **下一步**，在 **迁移选项** 页面，配置各项参数。

9. 单击 **预检查**，系统对数据迁移项目进行预检查。

10. 单击 **启动项目**，启动该项目的增量同步任务。
