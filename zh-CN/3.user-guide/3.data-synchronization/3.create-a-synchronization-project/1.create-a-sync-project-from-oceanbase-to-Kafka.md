# 创建 OceanBase 社区版至 Kafka 的数据同步项目

Kafka 是目前广泛应用的高性能分布式流计算平台，OceanBase 迁移服务（OceanBase Migration Service，OMS）社区版支持 OceanBase 社区版 MySQL 租户与自建 Kafka 数据源之间的数据实时同步，扩展消息处理能力，广泛应用于实时数据仓库搭建、数据查询和报表分流等业务场景。 

OMS 社区版支持数据同步至消息队列产品，扩展业务在监控数据聚合、流式数据处理、在线和离线分析等大数据领域的全方位应用。

## 使用限制

* 数据同步的对象仅支持物理表，不支持其它对象。

* 支持的 Kafka 版本为 0.9、1.0 和 2.x。
  
* 数据同步过程中，如果您在源端修改了同步范围内的表名称，且重命名后的名称不在同步对象中，则该部分数据将不被同步至目标 Kafka 实例中。
  
* 当一条链路意外中断进行断点续传时，Kafka 实例中可能会存在部分重复数据（最近一分钟内），因此下游系统需要具备排重能力。
  
* 待同步的表名和其中的列名不能包含中文字符。

## 操作步骤

1. 新建同步项目。
   
   1. 登录 OMS 社区版控制台。
   
   2. 在左侧导航栏，单击 **数据同步**。
   
   3. 在 **数据同步** 页面，单击右上角的 **新建同步项目**。
   
2. 在 **选择源和目标** 页面，配置各项参数。
   
   |   **参数**   |    **描述**      |
   |---|---|
   | 同步项目名称 | 支持中文、数字和字母的组合，不得超过 64 个字符。                                                    |
   | 标签 | 单击文本框，在下拉列表中选择目标标签。您也可以单击 **管理标签**，进行新建、修改和删除。|
   | 源节点    | 如果您已创建 OceanBase 社区版数据源，请从下拉列表中进行选择。如果未创建，请单击下拉列表中的 **添加数据源**，在右侧对话框进行添加。参数详情请参见 [添加 OceanBase-CE 数据源](../../4.manage-data-sources/1.add-a-data-source/1.add-an-oceanbase-ce-data-source.md)。|
   | 目标节点   | 如果您已创建 Kafka 数据源，请从下拉列表中进行选择。如果未创建，请单击下拉列表中的 **添加数据源**，在右侧对话框进行添加。参数详情请参见 [添加 Kafka 数据源](../../4.manage-data-sources/1.add-a-data-source/3.add-a-Kafka-data-source.md)。                                           |

3. 单击 **下一步**。

4. 在 **选择同步类型及对象** 页面，勾选当前数据同步项目的 **同步类型和配置**。
   
   **同步类型和配置** 包括 **结构同步**、**全量同步** 和 **增量同步**。**全量同步** 支持无主键表的同步，**增量同步** 仅支持 **数据变更 DML**（包括 Insert、Delete 和 Update）。

5. 在 **选择同步类型及对象** 页面，选择同步范围。
   
   同步 OceanBase 社区版 MySQL 租户的数据至 Kafka 时，支持多表到多 Topic 的同步。
   
   1. 在选择区域左侧选中需要同步的对象。
   
   2. 单击 **>**。
   
   3. 在 **将对象映射至 Topic** 对话框中，选择需要的映射方式进行配置。

        |**参数**|**描述**|
        |---|---|
        |新建 Topic|在文本框中输入新建 Topic 的名称。支持 3~64 位字符, 且只能包含英文、数字、短横线（-）、下划线（_）和英文句号（.）。<br>结构同步成功后，在 Kafka 侧能够查询到新建的 Topic。其分区数量默认为 3 个，分区副本数量默认为 1 个，不支持修改。|
        |选择 Topic|OMS 社区版提供查询 Kafka Topic 的能力，您可以单击 **选择 Topic**，在 **已有 Topic** 下拉列表中，搜索并选中需要同步的 Topic。|
        |批量生成 Topic|批量生成 Topic 的规则为 `Topic_${Database Name}_${Table Name}`。|

   4. 单击 **确定**。
   
        选择同步对象后，OMS 社区版支持对目标端对象进行更改 Topic、设置分片列、移除单个对象或全部对象等操作。目标端对象的结构为 Topic>DataBase>Table。

        |**操作**|**步骤**|
        |---|---|
        |更改 Topic| <ol><li>在选择区域的右侧列表中，鼠标悬停至目标对象。<li>单击显示的 **更改 Topic**。<li>在 **将对象映射至 Topic** 的对话框中，更改需要同步的 Topic。<li>单击 **确定**。</ol>|
        |设置|<ol><li>在选择区域的右侧列表中，鼠标悬停至目标对象。<li>单击显示的 **设置**。<li>在 **设置** 对话框的 **分片列** 下拉列表中，选择目标分片列。您可以选择多个字段作为分片列，该参数为选填。<br>选择分片列时，如果没有特殊情况，默认选择主键即可。如果存在主键负载不均衡的情况，请选择唯一性标识且负载相对均衡的字段作为分片列。<br>请确保分片列的正确性。分片列填写错误，会导致数据同步项目失败。分片列的主要作用如下：<ul><li>负载均衡：在目标端可以进行并发写入的情况下，通过分片列区分发送消息需要使用的特定线程。<li>有序性：由于存在并发写入可能导致的无序问题，OMS 社区版确保在分片列的值相同的情况下，用户接收到的消息是有序的。此处的有序是指变更顺序（DML 对于一列的执行顺序）。</ul></ol>|
        |移除/全部移除|OMS 社区版支持移除单个或全部同步对象。<ul><li>移除单个同步对象<br>在选择区域的右侧列表中，鼠标悬停至目标对象，单击显示的 **移除**，即可移除该同步对象。<li>移除全部同步对象<br>在选择区域的右侧列表中，单击右上角的 **全部移除**。在对话框中，单击 **确定**，即可移除全部同步对象。</ul>|

6. 单击 **下一步**。
   
7. 在 **同步选项** 页面，配置各项参数。

    <table>
        <tr>
        <td><b>分类</td>
        <td><b>参数</td>
        <td><b>描述</td>
        </tr>
        <tr>
        <td>同步设置</td>
        <td>增量同步起始位点</td>
        <td><ul><li>如果设置同步类型和配置时已勾选 <b>全量同步</b>，此处默认为项目启动时间，不支持修改。<li>如果设置同步类型和配置时未勾选 <b>全量同步</b>，请在此处指定同步某个时间节点之后的数据，默认为当前系统时间。您可以选择时间节点，也可以直接输入时间戳。<br><b>注意</b>：仅支持选择当前时间，或当前时间之前的时间点。<br>该位点与当前归档日志的保留时间密切相关。如果无特殊要求，可以从当前位点开始启动。</ul></td>
        <tr>
        <td rowspan="3">高级选项</td>
        <td>序列化方式</td>
        <td>控制数据同步至 Kafka 的消息格式，目前支持 Default、Canal、Dataworks（支持 2.0 版本）、SharePlex 和 DefaultExtendColumnType。</td>
        </tr>
        <tr>
        <td>开启事务内序列编号</td>
        <td>根据需求，设置是否开启事务内保持排序。如果开启，OMS 社区版可以为一个事务发送至下游进行顺序标识。<br><b>注意：</b>该参数仅对 <b>SharePlex</b> 格式生效，目的是为了确保您能够获取构成交易的 DML 语句的序号。<br>例如，在同一交易内包含 10 条 DML 语句（顺序为 1，2，3…10），则 OMS 社区版会按照 1，2，3 ...10 的顺序投递至目标端。<br>该选项会有性能损耗，请根据业务性质选择性开启。</td>
        </tr>
        <tr>
        <td>分区规则</td>
        <td>同步源端数据至 Kafka Topic 的规则，目前支持 Hash 和 One。<ul><li>Hash 表示 OMS 社区版使用一定的 Hash 算法，根据主键值或分片列值 Hash 选择 Kafka Topic 的分区。<li>One 表示 JSON 消息会投递至 Topic 下的某个分区，目的是为了保持排序。<br>该选项会有性能损耗，请根据业务性质选择性开启。</ul></td>
        </tr>
    </table>

8. 单击 **预检查**。
   
   在 **预检查** 环节，OMS 社区版会检测和目标端 Kafka 实例的连接情况。如果预检查报错，请排查并处理问题后，重新执行预检查，直至预检查成功。

9.  单击 **启动任务**，启动该项目的增量同步等各项任务。

    如果您暂时无需启动任务，请单击 **保存**，跳转至数据同步项目的详情页面，您可以根据需要手动启动数据同步项目。