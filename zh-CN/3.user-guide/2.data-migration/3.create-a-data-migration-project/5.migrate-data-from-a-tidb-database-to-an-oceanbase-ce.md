# 创建 TiDB 数据库至 OceanBase 社区版的数据迁移项目

本文为您介绍如何使用 OceanBase 迁移服务（OceanBase Migration Service，OMS）社区版迁移 TiDB 数据库的数据至 OceanBase 社区版。

## 使用限制

* 目前支持 TiDB 数据库 4.x 和 5.4 版本。
  
* 库到库长期同步中，OMS 社区版不支持目标端存在 Trigger。

* OMS 社区版不支持迁移 TiDB 数据库的无主键表至 OceanBase 社区版。

* OMS 社区版不支持迁移 TiDB 数据库中包含空格的数据至 OceanBase 社区版。

* 如果源端字符集为 UTF-8，目标端建议您使用 UTF-8 或大于 UTF-8 的字符集编码。

* TiDB 数据库至 OceanBase 社区版的反向增量中，当 OceanBase 社区版为具有全局唯一索引的多分区表时，如果您更新了表的分区键的值，可能导致数据迁移过程中丢失数据。
  
* 请勿向 TiCDC 同步的 Topic 中自己写数据，否则会导致 JDBC-Connector 异常，报空指针的错误。
  
* OMS 社区版仅支持 TiCDC Open Protocol，不支持其它协议。如果您使用不支持的协议，会导致 JDBC-Connector 异常，报空指针的错误。

* 当目标端的字段长度小于源端字段长度时，本字段的数据会被数据库自动截断，造成源端和目标端的数据不一致。

## 数据类型映射

|    TiDB 数据库     | OceanBase 社区版 |
|------------------|------------------------|
| INTEGER          | INTEGER                |
| TYNYINT          | TYNYINT                |
| MEDIUMINT        | MEDIUMINT              |
| BIGINT           | BIGINT                 |
| SMALLINT         | SMALLINT               |
| DECIMAL          | DECIMAL                |
| NUMERIC          | NUMERIC                |
| FLOAT            | FLOAT                  |
| REAL             | REAL                   |
| DOUBLE PRECISION | DOUBLE PRECISION       |
| BIT              | BIT                    |
| CHAR             | CHAR                   |
| VARCHAR          | VARCHAR                |
| BINARY           | BINARY                 |
| VARBINARY        | VARBINARY              |
| BLOB             | BLOB                   |
| TEXT             | TEXT                   |
| ENUM             | ENUM                   |
| SET              | SET                    |
| DATE             | DATE                   |
| DATETIME         | DATETIME               |
| TIMESTAMP        | TIMESTAMP              |
| TIME             | TIME                   |
| YEAR             | YEAR                   |

## 创建数据迁移项目

1. 新建数据迁移项目。

   1. 登录 OMS 社区版控制台。

   2. 在左侧导航栏，单击 **数据迁移**。

   3. 在 **数据迁移** 页面，单击右上角的 **新建迁移项目**。

2. 在 **选择源和目标** 页面，配置各项参数。

   |   参数   |                                                        描述                                               |
   |--------|------------------------------------------------------------------------------|
   | 迁移项目名称 | 建议使用中文、数字和字母的组合。名称中不能包含空格，且长度不得超过 64 个字符。                                  |
   | 标签     | 单击文本框，在下拉列表中选择目标标签。您也可以单击 **管理标签**，进行新建、修改和删除。详情请参见 [通过标签管理数据迁移项目](../4.manage-data-migration-projects/5.use-tags-to-manage-data-migration-projects.md)。                                                                                                              |
   | 源端    | 如果您已创建 TiDB 数据源，请从下拉列表中进行选择。如果未创建，请单击下拉列表中的 **添加数据源**，在右侧对话框进行添加。参数详情请参见 [添加 TiDB 数据源](../../4.manage-data-sources/1.add-a-data-source/4.add-a-tidb-data-source.md)。<br> **注意：**<br> 如果源端 TiDB 数据源未绑定有效的 Kafka 数据源和 Topic 信息，则不支持增量同步。 |
   | 目标端   | 如果您已创建 OceanBase-CE 数据源，请从下拉列表中进行选择。如果未创建，请单击下拉列表中的 **添加数据源**，在右侧对话框进行添加。参数详情请参见 [添加 OceanBase-CE 数据源](../../4.manage-data-sources/1.add-a-data-source/1.add-an-oceanbase-ce-data-source.md)。             |

3. 单击 **下一步**。

4. 单击弹出提示框中的 **我知道了**。

   请注意目前本项目仅支持具有主键或者非空唯一索引的表，其它表会自动过滤。

5. 在 **选择迁移类型** 页面，配置各项参数。

   **迁移类型** 包括 **结构迁移**、**全量迁移**、**增量同步**、**全量校验** 和 **反向增量**。

   | 迁移类型 |       使用限制        |
   |------|-------------------|
   | 全量迁移 | 如果选择 **全量迁移**，建议您在迁移数据前，使用 `ANALYZE` 语句收集 TiDB 数据库的统计信息。                                   |
   | 增量同步 | **增量同步** 的 **数据变更 DML** 包括 `Insert`、`Delete` 和 `Update`，您可以根据需求进行选择。<br>如果您在创建 TiDB 数据源时，未绑定 Kafka 数据源，则无法选择 **增量同步**。                                             |
   | 全量校验 | <ul><li> 如果选择 **全量校验**，建议您在全量校验开始前，分别收集 TiDB 数据库和 OceanBase 社区版的统计信息。  <li> 如果您选择了 **增量同步**，且数据变更 DML 选项中未选择所有的 DML，则无法选择 **全量校验**。</ul>    |
   | 反向增量 | 以下情况均不支持选择 **反向增量**： <ul><li> 存在多表汇聚的情况。   <li>存在 Schema 多到一映射的情况。  </ul>     |

6. （可选）单击 **下一步**。如果您选择了 **反向增量**，且目标端 OceanBase 社区版数据源未配置 Configurl、用户名和密码，则会弹出 **数据源补充信息** 对话框，提醒您配置相应参数。参数详情请参见 [添加 OceanBase-CE 数据源](../../4.manage-data-sources/1.add-a-data-source/1.add-an-oceanbase-ce-data-source.md)。

   补充完成后，单击 **测试连通性**。测试连接成功后，单击 **保存**。

7. 单击 **下一步**，在 **选择对象** 页面，选择迁移对象和迁移范围。

   您可以通过 **指定对象** 和 **匹配规则** 两个入口选择迁移对象。

   * 选择 **指定对象**，在左侧选中需要迁移的对象，单击 **\>**，将其添加至右侧列表中。您可以选择一个或多个库的表、视图作为迁移对象。

     >**注意：**
     >
     >* 待迁移的表名和其中的列名不能包含中文字符。
     >
     >* 当数据库的库名或表名存在 "$$" 字符时，会影响数据迁移项目的创建。

     迁移 TiDB 数据库的数据至 OceanBase 社区版时，OMS 社区版支持通过文本导入对象、重命名对象名称、设置行过滤、查看列信息，以及移除单个或全部迁移对象。

     |   操作    |                                                                            步骤                                                                                   |
     |---------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
     | 导入对象    | <ol><li> 在 **选择迁移范围** 区域的右侧列表中，单击右上角的 **导入对象**。   <li>在对话框中，单击 **确定**。<br> **注意：**<br> 导入会覆盖之前的操作选择，请谨慎操作。  <li>在 **导入迁移对象** 对话框中，输入或导入需要迁移的对象。例如，`SCHEMA.TB1 | SCHEMA.TB2 | SCHEMA.TB3=SCHEMA_RENAME.TB3_RENAME`，库、表名映射使用等号（=）连接。<br> 建议迁移对象不超过 2000 个。如果超过该数量，则建议使用 **匹配规则** 模式。 <br>同时，您可以通过导入 CSV 文件的方式进行库表重命名、设置行过滤条件等操作。详情请参见 [下载和导入迁移对象配置](../4.manage-data-migration-projects/6.download-and-import-the-settings-of-migration-objects.md)。   <li> 单击 **检验合法性**。   <li> 通过合法性的检验后，单击 **确定**。</ol>    |
     | 重命名     | <ol><li> 在 **选择迁移范围** 区域的右侧列表中，鼠标悬停至目标对象。  <li> 单击显示的 **重命名**。   <li> 输入修改后的名称，单击 **确定**。  </ol>                                                                                               |
     | 移除/全部移除 | OMS 社区版支持在数据映射时，对暂时选中到目标端的单个或多个对象进行移除操作。 <ul><li>移除单个迁移对象 <br>在 **选择迁移范围** 区域的右侧列表中，鼠标悬停至目标对象，单击显示的 **移除**，即可移除该迁移对象。  <li> 移除全部迁移对象 <br>在 **选择迁移范围** 区域的右侧列表中，单击右上角的 **全部移除**。在对话框中，单击 **确定**，即可移除全部迁移对象。</ul>     |

   * 选择 **匹配规则**，详情请参见 [配置迁移对象的匹配规则](../5.configure-matching-rules-for-migration-objects.md)。

8. 单击 **下一步**，在 **迁移选项** 页面，配置各项参数。

   |参数|描述|
   |----|----------------------------------|
   |全量迁移并发速度|包括 **平稳**、**正常** 和 **快速**。全量迁移的性能不同，全量迁移任务所需要的资源也不同。 <br>您也可以通过修改具体 Checker 组件的配置，实现自定义并发参数。 <br>**注意**：<br> 在 **选择迁移类型** 页面选中 **全量迁移**，才支持设置该选项。 |
   |全量校验并发速度|包括 **平稳**、**正常** 和 **快速**。不同档位对源端和目标端的资源消耗不同。<br>您也可以通过修改具体 Checker 组件的配置，实现自定义并发参数。|
   |增量记录保存时间|OMS 社区版中增量解析文件缓存的时长。配置的保存时间越长，OMS 社区版 Store 组件需要消耗的磁盘空间越大。  |
   |全量迁移是否允许目标表非空|全量迁移允许目标表非空时，全量校验采用的是 `in` 判断，无需移除全量校验。 <br>**注意**：<br>在 **选择迁移类型** 页面选中 **全量迁移**，才支持设置该选项。   |
   |是否允许索引后置|您可以设置是否允许全量数据迁移完成后再创建索引，索引后置能够减少全量迁移的时间。<br>**注意**：<ul><li>在 **选择迁移类型** 页面同时选中 **结构迁移** 和 **全量迁移**，才支持设置该选项。  <li>仅非唯一键索引支持后置创建。</ul>|

9. 单击 **预检查**，系统对数据迁移项目进行预检查。

   在 **预检查** 环节，OMS 社区版会检查数据库用户的读写权限、数据库的网络连接等是否符合要求。全部检查项目均通过后才能启动数据迁移项目。如果预检查报错，请排查并处理问题后，重新执行预检查，直至预检查成功。如果需要跳过某项预检查，您可以在系统配置中进行设置。

10. 单击 **启动项目**。

    如果您暂时无需启动项目，请单击 **保存**，跳转至数据迁移项目的详情页面，您可以根据需要进行手动启动。如果您需要查看详情，请参见 [查看数据迁移项目的详情](../4.manage-data-migration-projects/1.view-details-of-a-data-migration-project.md)。

## 启动数据迁移项目

全部检查项目完成后，当且仅当全部检查成功，才可以启动项目。如果有失败的检查项目，请手动修复后，在当前界面复检。数据迁移项目启动后，依次执行选择的迁移类型：

1. 结构迁移

   >**注意：**
   >
   >OMS 社区版不支持目标端编码为 Latin，且建表语句或注释存在中文。

   负责迁移源库中的数据对象定义（表、索引、约束、注释和视图等）至 OceanBase 社区版目标库中，会自动过滤临时表。当源端数据库非 OceanBase 社区版时，会依据目标 OceanBase 社区版的语法定义标准进行数据类型和 SQL 语法的自动转换和拼装，然后复制至 OceanBase 社区版目标库中。

   您可以查看 **表** 和 **视图** 的迁移进度，并对目标对象进行以下操作：

   * **查看创建语法**：单击后，您可以 **查看表创建语法** 和 **修改索引创建语法**。

     如果表创建语法完全兼容，为您展示在 OBServer 执行的 DDL 语法。不完全兼容，则展示转换后的创建语法。

   * **修改创建语法并重试**：运行失败的 DDL 和报错，您可以检查并修改该条 DDL 转换结果的定义，再次迁移至目标端。

   * **查看数据库返回码**：失败的结构迁移任务，展示 DDL 语句和 OBServer 上执行的错误信息。

   * **重试** / **重试全部失败对象**：失败的结构迁移任务，您可以依次进行重试，也可以 **重试全部失败对象**。

   * **跳过** / **批量跳过**：失败的结构迁移任务，您可以依次跳过。您也可以批量选择需要跳过的对象，单击右上角的 **批量跳过**。跳过对象时，索引会一并跳过。跳过表时，请手动在目标端创建跳过的 DDL。

   * **移除** / **批量移除**：失败的结构迁移任务，您可以依次进行移除。您也可以批量选择需要移除的对象，单击右上角的 **批量移除**。移除对象时，索引会一并移除。

2. 全量迁移

   迁移源库表的存量数据至目标端对应的表中。您可以在 **全量迁移** 页面，查看 **表对象**、**表索引** 和 **全量迁移性能**。只有表对象和表索引均迁移完成，全量迁移的状态才会显示已完成。

   * 在 **表对象** 页签，您可以查看对象名称、源库、目标库、预估数据量、已完成数据量和对应的状态。

   * 在 **表索引** 页签，您可以查看表对象、源库、目标库、创建时间、结束时间、耗时及其对应的状态。同时，您可以单击目标对象后的 **查看创建语法**，查看索引的创建语法。

   * 在 **全量迁移性能** 页签，您可以图形化查看 **源端 RPS**、**目标端 RPS**、**源端迁移流量** 和 **目标端迁移流量**，以及性能基准等性能数据，帮助您有效识别性能相关问题。

   全量迁移加上增量同步，可以确保目标端数据库与源端数据库的最终一致性。如果全量迁移过程中有失败的对象，会为您展示具体的失败原因。

   >**注意：**
   >
   >* 如果您在选择 **迁移类型** 时未配置 **结构迁移**，则全量迁移时，OMS 社区版会以源端和目标端匹配的字段进行迁移，不会检查表结构是否一致。
   >
   >* 在全量迁移完成之后，且后续步骤已启动的情况下，不允许在 **运维监控** \> **组件** \> **Checker** 页面，单击目标 Checker 组件后的 **重跑**。

3. 增量同步

   增量同步任务开始后，会同步源库发生变化的数据至目标端数据库对应的表中。

   当源库不断有业务写入时，OMS 社区版会在全量数据同步启动前，启动增量拉取模块，以拉取源实例中的增量更新数据，对其进行解析、封装，并存储至 OMS 社区版中。

   当全量迁移完成后，OMS 社区版会启动增量数据回放模块，从增量数据拉取模块中获取增量数据。增量数据经过过滤、映射和转换后，再同步至目标实例中。

   您可以在增量同步区域查看延迟时间、当前位点时间，以及迁移流量等增量同步性能信息。延迟时间的显示逻辑为：X 秒（Y 秒前更新），Y 小于 20 秒属于正常情况。

   数据迁移项目处于 **已暂停** 和 **失败** 状态时，您可以修改 **当前位点时间**。请注意修改增量同步位点时，您无法选择当前时间之后的时间戳，且修改增量同步位点后可能会导致数据重复或数据丢失，请谨慎操作。

4. 全量校验

   在全量数据迁移完成，增量数据迁移至目标端并与源端基本追平后，OMS 社区版会自动发起一轮针对源库配置的数据表和目标表的全量数据校验任务。

   >**注意：**
   >
   >* 如果您在选择 **迁移类型** 时未配置 **结构迁移**，则全量校验时，OMS 社区版会以源端和目标端匹配的字段进行校验，不会检查表结构是否一致。
   >
   >* 全量校验期间，如果源端对表进行 `create`、`drop`、`alter` 和 `rename` 操作，可能导致全量校验退出。

   增量数据同步过程中，您也可以发起自定义的数据校验，OMS 社区版会提供相应的接口。

   您可以在 **全量校验** 页面查看全量校验的整体状态、启动时间、结束时间、总计耗时、预估总行数、已完成迁移行数、实时流量和 RPS 等信息。

   **全量校验** 页面包括 **全部校验对象** 和 **全量校验性能** 页签：

   * 在 **全部校验对象** 页签，您可以查看校验的进度和校验对象列表。

     * 对于全部迁移对象，均可以查看指定对象的名称、对应源库和目标库、全量校验进度、结果和结果摘要。

     * 支持根据源库和目标库进行筛选。

     * 支持勾选 **只查看已完成对象**，查看当前时间点已完成结构迁移的对象名称等基本信息。

     * 如果您需要对全部迁移对象再次进行全量校验，请单击 **再次校验** \> **重启全量校验**。

     * 存在校检结果不一致的表时：

       如果您需要重新校验表中的全部数据，请单击 **再次校验** \> **重新校验异常的表**。

       如果您仅需要重新校验表中不一致的数据，请单击 **再次校验** \> **仅校验不一致的表记录**。

       >**注意：**
       >
       >如果源端为空，则不支持订正操作。

   * 在 **全量校验性能** 页签，您可以图形化查看 **源端 RPS**、**目标端 RPS**、**源端迁移流量** 和 **目标端迁移流量**，以及性能基准等性能数据，帮助您有效识别性能相关问题。

   OMS 社区版支持校验中或校验失败的项目跳过全量校验。在 **全量校验** 页面，单击 **跳过全量校验**，并在弹出对话框中，单击 **确定**。

   全量校验完成后，您可以单击 **进入下一阶段**，启动正向切换。进入切换流程后，您将无法复检当前校验任务进行数据比对和数据订正。

5. 正向切换

   正向切换（传统意义上的系统割接流程的抽象化、标准化）不会操作业务应用连接的切换，是 OMS 社区版的数据迁移链路配合应用切换前后需要执行的任务流。您需要保证在应用连接切换至目标端前完成正向切换的全部流程。

   正向切换是选择数据迁移便会编排进来的一个流程，您需要终止正向增量同步，删除迁移依赖的附加列和唯一索引，补充在同步过程中被 OMS 社区版过滤掉 Check 约束，并激活目标端 Trigger/FK（迁移前该类对象需要被禁用，否则将引起数据不一致）等，保证新迁移出来的数据库完整、可用。

   如果您配置了反向增量，切换会多编排进来启动反向增量以及禁用源端 Trigger/FK 的子任务，启动从目标端到源端的实时增量同步，保障业务数据回流至原源端数据库，提供随时切换应用的可能性。

   1. 启动正向切换

      该步骤不会停止链路，仅确认即将开始执行的切换流程。用户进入至正向切换任务流时，需要手动单击 **启动正向切换**。

      >**注意：**
      >
      >启动正向切换前，请确保源端数据源为即将停写或者已经停写状态。

   2. 切换预检查

      用于检查当前项目状态是否具备切换条件。预检查包括以下步骤：

      * 同步延迟检查：如果启动增量同步后，延迟在 15 秒内，则预检查通过。如果未启动增量同步，则预检查自动通过。

      * 源端迁移用户写权限检查。

      如果预检查通过，会自动执行下一步操作。如果预检查未通过，会提示报错详情。

      如果预检查未通过，您可以进行 **重试** 或 **跳过** 操作。

      如果单击 **跳过**，需要在弹出的对话框中，再次单击 **跳过**。

   3. 启动目标端 Store

      启动目标端增量拉取，创建并启动目标端 Store。如果启动失败，您可以进行 **重试** 或 **跳过** 操作。、

   4. 确认源端停写

      在 **确认源端停写** 区域，单击 **确定**，确认源端无增量数据产生。

   5. 确认同步追平停写位点

      OMS 社区版自动检查源端和目标端处于一致位点。检查完成后，展示当前增量同步延迟时间和增量同步位点。

   6. 停止正向同步

      停止源端到目标端的 JDBCWriter。如果停止失败，您可以进行 **重试** 或 **跳过** 操作。

   7. 执行数据库对象处理

      该步骤会完成数据库对象的迁移，删除 OMS 社区版附加列和索引，补充结构迁移自动忽略的约束，确认 Trigger 或 Sequence 等对象已经手工迁移完成，以及确认源端 Trigger 或 FK 已关闭。

      您需要手动单击 **运行**，来处理数据库对象。对于运行中的项目，您可以执行 **查看日志** 和 **跳过** 操作。自行处理的项目需要手动单击 **标记完成**。待全部标记完成后，进行下一步。

   8. 启动反向增量

      在 **启动反向增量** 区域，单击 **启动反向增量**，启动目标端到源端的 JDBCWriter。等待页面提示 **反向增量启动成功** 即可。

6. 反向增量启动成功后，单击 **反向增量** 页签，查看 **启动时间**、**反向同步性能** 等详情。

   反向增量性能包括：

   * 延迟时间：目标端增量变更被同步至源端的滞后时间，单位为秒。
  
   * 迁移流量：目标端增量变更数据被同步至源端的流量吞吐，单位为 KB/s。
