# 告警设置

OceanBase 迁移服务（OceanBase Migration Service，OMS）社区版支持通过管理控制台页面，配置告警内置监控项、告警阈值和告警频率，并支持新建、编辑和删除告警通道。

## 背景信息

目前，OMS 社区版长期同步链路状态等监控项目的告警通道，通过 OCP 对接到客户环境。您可以通过 OMS 社区版的 **告警设置** 页面，对数据迁移和数据同步项目进行不同保护级别对应的阈值设置。

OMS 社区版支持的告警级别包括 **无保护**、**高保护**、**中保护** 和 **低保护**：

* 无保护：无需告警，适用于短期迁移或实时性要求较低的业务场景。

* 高保护：适用于延迟要求极高的业务场景。

  高保护的触发条件如下：

  * 同步延迟大于设定的阈值。
  
  * 结构迁移或全量任务中断的时长大于设定的阈值。

* 中保护：适用于延迟要求较高的业务场景，其设定的阈值需要大于、等于高保护设置的阈值。

* 低保护：适用于延迟要求不高的业务场景，其设定的阈值需要大于、等于中保护设置的阈值。

Admin 用户可以修改各个保护级别的 **告警阈值** 和 **告警频率**，普通用户可以为自己的数据同步项目标记告警级别，但仅支持查看各个保护级别的 **告警阈值** 和 **告警频率**。

## 操作步骤

1. 登录 OMS 社区版控制台。

2. 在左侧导航栏，单击 **系统管理** \> **告警**。

3. 在 **告警** 页面，单击 **告警设置** 页签。

4. 在 **告警设置** 页面，根据业务需求，设置 **高保护**、**中保护**、**低保护** 的 **告警阈值** 和 **告警频率**。

   | 保护级别 |  参数  |                        描述                        |
   |------|------|--------------------------------------------------|
   | 高保护  | 同步延迟 | 设定范围为 1 秒 \~ 5 分钟。                               |
   | 高保护  | 中断时间 | 设定范围为 1 秒 \~ 5 分钟。                               |
   | 中保护  | 同步延迟 | 设定范围为 30 秒 \~ 10 分钟。                             |
   | 中保护  | 中断时间 | 设定范围为 30 秒 \~ 10 分钟。                             |
   | 低保护  | 同步延迟 | 设定范围为 5 分钟 \~ 3 小时。                              |
   | 低保护  | 中断时间 | 设定范围为 5 分钟 \~ 3 小时。                              |
   | 告警频率       || 默认每 3 分钟发送一次。您可以根据业务需求进行设置，设定范围为 1 分钟 \~ 600 分钟。 |

5. 设置成功后，您可以在 **数据迁移** 和 **数据同步** 页面，查看和修改告警等级。

   以 **数据迁移** 页面为例，操作如下：

   1. 在左侧导航栏，单击 **数据迁移**。

   2. 在 **迁移项目列表** 页面，单击目标迁移项目后的 **更多操作** \> **修改告警等级**。

   3. 在 **修改告警等级** 对话框，选中需要的告警等级。

   4. 单击 **提交**。

## 新建告警通道

1. 在 OMS 社区版控制台的左侧导航栏，单击 **系统管理** \> **告警**。

2. 在 **告警** 页面，单击 **告警设置** 页签。

3. 在 **告警通道列表** 区域，单击右上角的 **新建告警通道**。

   ![新建](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/4980175261/p291330.png)

4. 在 **新建告警通道** 对话框，配置各项参数。

   |  参数  |                                                                                                                                                   描述                                                                                                                                                    |
   |------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | 通道名称 | 自定义输入通道的名称，仅支持中文、英文、数字和下划线（_），且不能超过 50 个字符。                                                                                                                                                                                                                                                             |
   | 通道类型 | 包括 **OCP 告警** 和 **钉钉告警**。            |
   | 配置信息 | 根据选择的通道类型，填写配置信息： <ul><li> 当选择 **OCP 告警** 时，从关联的 OCP 列表中选择一个 OCP。   <li> 当选择 **钉钉告警** 时，请输入钉钉机器人 Webhook 地址的 access_token 信息。详情请参见下文的《获取钉钉机器人的 access_token 信息》。<br> 设置钉钉告警后，您可以通过指定的钉钉群接收告警通知。</ul>    |

5. 单击 **测试连接**。

6. 测试通过后，单击 **提交**。

新建成功后，您可以进行 **编辑** 和 **删除** 操作：

* 编辑告警通道

  1. 单击目标告警通道后的 **编辑**。

  2. 在 **修改告警通道** 对话框，修改各项参数。

     您可以修改告警通道的 **通道名称**、**通道类型** 和 **配置信息**。
  
  3. 单击 **测试连接**。
  
  4. 测试通过后，单击 **提交**。

* 删除告警通道

  1. 单击目标告警通道后的 **删除**。
  
  2. 在弹出的对话框中，单击 **删除**。

## 获取钉钉机器人的 access_token 信息

1. 打开目标钉钉群，单击右上角的 **群设置** 图标。

2. 单击 **智能群助手**。

3. 在 **智能群助手** 页面，单击 **添加机器人**。

4. 在 **群机器人** 页面，单击 **+** 图标。

5. 在 **选择要添加的机器人** 页面，单击 **自定义**。

6. 在 **机器人详情** 页面，单击 **添加**。

7. 在 **添加机器人** 页面，配置各项参数。

   |  参数   |                                                                                          描述                                                                                          |
   |-------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | 机器人名字 | 自定义机器人的名称。                                                                                                                                                                           |
   | 添加到群组 | 添加机器人的钉钉群，不支持修改。                                                                                                                                                                     |
   | 安全设置  | 包括 **自定义关键词**、**加签** 和 **IP 地址（段）**。请至少选择一种安全设置，保障自定义机器人安全。详情请参见钉钉官方文档 [自定义机器人安全设置](https://open.dingtalk.com/document/robots/customize-robot-security-settings)。 |

8. 选中 **我已阅读并同意《自定义机器人服务及免责条款》**，单击 **完成**。

9. 单击 **复制**，获取 Webhook 地址，截取 `access_token=` 之后的 token 信息。您也可以直接复制机器人 Webhook 中的 access_token 信息。

   >**注意：**
   >
   >请妥善保管 Webhook 地址，一旦泄露会有安全风险。

   ![token信息](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7617297461/p392777.png)

10. 单击 **完成**。
